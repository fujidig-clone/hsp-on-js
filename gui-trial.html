<!DOCTYPE html>
<html lang="ja">
<head profile="http://purl.org/net/ns/metaprof">
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<meta http-equiv="Content-Script-Type" content="text/javascript">
<meta http-equiv="Content-Style-Type" content="text/css">
<link rev="made" href="mailto:fuji.rosen@gmail.com">
<title>HSP on JS GUI の試み</title>
<script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1.2/jquery.min.js"></script>
<script type="text/javascript" src="hsp-on-js-core-0.0.10.js" charset="utf-8"></script>
<script type="text/javascript" src="gui-trial.js" charset="utf-8"></script>
<script type="text/javascript">
HSPonJS.emptyFunction = function(){};

function XHRReadURL(url, success, error) {
	var xhr;
	if(window.XMLHttpRequest) {
		xhr = new XMLHttpRequest();
	} else {
		try {
			xhr = new ActiveXObject("Msxml2.XMLHTTP");
		} catch(e) {
			xhr = new ActiveXObject("Microsoft.XMLHTTP");
		}
	}
	xhr.open("GET", url, true);
	xhr.onreadystatechange = function(){
		if(!(xhr && xhr.readyState == 4)) return;
		if(200 <= xhr.status && xhr.status < 300) {
			var data = xhr.responseText;
			setTimeout(function(){success(data)}, 0);
		} else if(xhr.status) {
			setTimeout(function(){error()}, 0);
		}
		xhr.onreadystatechange = HSPonJS.emptyFunction;
		xhr = null;
	};
	xhr.send(null);
	return xhr;
}

with(HSPonJS) {
	Evaluator.prototype.disposeException = function disposeException(e) {
		if(e instanceof HSPError) {
			var insn = this.sequence[this.pc];
			var msg = '#Error '+e.errcode+' in line '+insn.lineNo+' ('+insn.fileName+') ';
			msg += this.getBuiltinFuncName(insn)||'';
			msg += "\n";
			msg += '--\x3e '+(e.message||ErrorMessages[e.errcode]);
			alert(msg);
			return;
		}
		if(e instanceof StopException) {
			return;
		}
		if(e instanceof WaitException) {
			var self = this;
			this.timeoutID = setTimeout(function(){
				self.timeoutID = undefined;
				self.resume();
			}, e.msec);
			return;
		}
		if(e instanceof FileReadException) {
			var self = this;
			self.fileReadXHR = XHRReadURL(
				e.path,
				function(data){
					self.fileReadXHR = null;
					self.resume(function(){ e.success.call(self, data); });
				},
				function() {
					self.fileReadXHR = null;
					self.resume(function(){ e.error.call(self); });
				});
			return;
		}
		if(e instanceof CallbackException) {
			this.resume(e.callback);
			return;
		}
		throw e;
	};
	Evaluator.prototype.quit = function quit() {
		if(this.timeoutID != undefined) {
			clearTimeout(this.timeoutID);
		}
		if(this.fileReadXHR) {
			this.fileReadXHR.abort();
			this.fileReadXHR = null;
		}
	};
}


function resizeTextarea(textarea) {
	textarea.setAttribute('rows', textarea.value.split("\n").length);
}

$(function() {
	var evaluators = [];
	function quitEvaluator(i) {
		if(evaluators[i]) {
			evaluators[i].quit();
			evaluators[i] = null;
		}
	}
	$('textarea').each(function(i) {
		var textarea = this;
		resizeTextarea(textarea);
		var runButton = document.createElement('button');
		runButton.setAttribute('type', 'button');
		runButton.appendChild(document.createTextNode('実行'));
		var messageSpan = document.createElement('span');
		messageSpan.appendChild(document.createTextNode('コンパイル中...'));
		messageSpan.style.display = 'none';
		var resetButton = document.createElement('button');
		resetButton.setAttribute('type', 'button');
		resetButton.style.display = 'none';
		resetButton.appendChild(document.createTextNode('リセット'));
		var canvas = document.createElement('canvas');
		canvas.width = 640;
		canvas.height = 480;
		canvas.style.display = 'none';
		var compileCount = 0;
		$(runButton).click(function() {
			var script = textarea.value;
			var ctx = canvas.getContext('2d');
			ctx.fillStyle = '#fff';
			ctx.fillRect(0, 0, canvas.width, canvas.height);
			ctx.fillStyle = '#000';
			quitEvaluator(i);
			messageSpan.style.display = '';
			var curCount = ++ compileCount;
			$.post('compile.cgi', {script: script}, function(jsonData) {
				if(curCount != compileCount) return;
				messageSpan.style.display = 'none';
				var data = eval('('+jsonData+')');
				if (!data.success) {
					alert(data.message);
					return;
				}
				var axdata = new HSPonJS.AXData(data.ax);
				try {
					var sequence = new HSPonJS.Compiler(axdata).compile();
				} catch(e) {
					if(!(e instanceof HSPonJS.CompileError)) throw e;
					alert('コンパイルエラー:\n'+e.message+'\nat '+e.hspFileName+':'+e.hspLineNumber);
					return;
				}
				var evaluator = new HSPonJS.Evaluator(axdata, sequence);
				evaluator.ctx = ctx;
				quitEvaluator(i);
				evaluators[i] = evaluator;
				canvas.style.display = 'block';
				resetButton.style.display = '';
				initializeEvaluator.call(evaluator);
				evaluator.evaluate();
			});
		});
		$(resetButton).click(function() {
			quitEvaluator(i);
			canvas.style.display = 'none';
			resetButton.style.display = 'none';
		});
		$(textarea)
			.after(canvas)
			.after(resetButton)
			.after(messageSpan)
			.after(runButton)
			.keyup(function(){resizeTextarea(this);});
	});
});
</script>
<style type="text/css">
textarea { width: 100%; }
</style>
</head>
<body>
<h1>HSP on JS GUI の試み</h1>
<div>
<textarea cols="100" rows="10">
repeat 8
  r = cnt * 255 / 7
  y = cnt * 50
  repeat 8
    g = cnt * 255 / 7
    x = cnt * 50
    color r, g
    boxf x, y, x + 49, y + 49
  loop
loop</textarea>
</div>

</body>
</html>
